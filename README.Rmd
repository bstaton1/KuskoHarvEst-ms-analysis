---
title: ""
output: 
  github_document:
    pandoc_args: ["--wrap=preserve"]
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

> This repository stores the code and data used to perform the analysis presented in the research article *In-season monitoring of harvest and effort form a large-scale subsistence salmon fishery in western Alaska* by authors B. Staton, W. Bechtol, L. Coggins, G. Decossas, and J. Esquible.
>
> The article is published in the _Canadian Journal of Fisheries and Aquatic Sciences_.

[![ArticleDOI](https://img.shields.io/badge/Article-10.1139/cjfas--2023--0369-blue?logo=doi&logoColor=f5f5f5)](https://doi.org/10.1139/cjfas-2023-0369)  
[![GitHub Repo Archive DOI](https://img.shields.io/badge/GitHub%20Repo%20Archive-10.5281/zenodo.10369148-blue?logo=github)](https://doi.org/10.5281/zenodo.10369148)

## Repository Structure

```{r subdir-table}
# define scripts and their purpose
tab = matrix(c(
  "`effort-simulation/`",       "Scripts to perform all simulation evaluations of the effort estimator and plot the results",
  "`validation/`",              "Scripts and data to perform the comparison of in-season harvest estimates to post-season harvest estimates",
  "`session-setup.R`",          "Loads packages, sets directories, creates miscellaneous objects used throughout several scripts",
  "`make-figures.R`",           "Creates all figures, except those for the effort simulation",
  "`make-tables.R`",            "Creates all numerical table output", 
  "`make-in-text-summaries.R`", "Calculates a variety of summary statistics that are presented the methods and results text"

), ncol = 2, byrow = TRUE)

kableExtra::kbl(tab, "markdown", col.names = c("Subdirectory", "Description"))

```

## Dependencies

### 'KuskoHarv*' Package Family

Users will need to install the R package ['KuskoHarvData'](https://github.com/bstaton1/KuskoHarvData).
From any R console, run:

```{r, eval = FALSE, echo = TRUE}
install.packages("remotes")
remotes::install_github("bstaton1/KuskoHarvData", ref = "v2023.5")
```

'KuskoHarvData' stores information generated by the in-season harvest monitoring program, including:

* Meta data for each opener (`data(openers_all, package = "KuskoHarvData")`)
* Interview data (`data(interview_data_all, package = "KuskoHarvData")`)
* Flight data (`data(flight_data_all, package = "KuskoHarvData")`)
* Harvest estimates (`data(harv_est_all, package = "KuskoHarvData")`)
* Effort estimates (`data(effort_est_all, package = "KuskoHarvData")`)

Two other packages (and their dependencies) will simultaneously be installed: `r htmltools::img(src = "https://github.com/bstaton1/KuskoHarvPred/blob/v2023.3/inst/rstudio/KuskoHarvPred-tool/resources/all-logo-grouped.png?raw=true", align = "right", height = "250px")`

* ['KuskoHarvEst'](https://github.com/bstaton1/KuskoHarvEst) ([v1.3.0](https://github.com/bstaton1/KuskoHarvEst/releases/tag/v1.3.0)): contains the workflow to produce harvest estimates from interview and flight data (calculations described in the manuscript).
* ['KuskoHarvUtils'](https://github.com/bstaton1/KuskoHarvUtils) ([v0.2.0](https://github.com/bstaton1/KuskoHarvUtils/releases/tag/v0.2.0)): contains several helper functions used throughout the 'KuskoHarv\*' family of packages.

To ensure installation of the exact package versions used upon publication, install these packages as follows:

```{r, eval = FALSE, echo = TRUE}
remotes::install_github("bstaton1/KuskoHarvUtils", ref = "v0.2.0")
remotes::install_github("bstaton1/KuskoHarvEst", ref = "v1.3.0")
```

### CRAN Packages

The table below shows all R packages (and their versions at time of publication; _typically_ should not matter, included for completeness) that are specifically called (typically with `pkg::fn()`) or loaded (using `library(pkg)`).
Users will need to have these packages installed prior to executing any of the code in this repo.

<details>
<summary><b>Click to Expand/Hide Packages Table</b></summary>

```{r pkg-table}

# detect all packages called specifically
used_pkgs = renv::dependencies(quiet = TRUE)$Package |> 
  unique() |> 
  sort()

# exclude any packages you don't wish to include in the table here
# e.g., anything used solely in building this Rmd
used_pkgs = used_pkgs[!used_pkgs %in% c("renv", "sessioninfo")]

# get the version of each package
versions = sapply(used_pkgs, function(pkg) paste(packageVersion(pkg), collapse = "."))

# get the description (i.e., title field of DESCRIPTION file) of each package
desc = sapply(used_pkgs, function(pkg) paste(packageDescription(pkg)$Title, collapse = ".")) |> 
  stringr::str_replace_all("\\n", " ")

# build a matrix
tab = cbind(pkg = used_pkgs, version = versions, desc = desc)
rownames(tab) = NULL

# build package name as a markdown link, with a URL placeholder
tab[,"pkg"] = paste0("[`", tab[,"pkg"], "`](URL)")

# function to get the URL that will replace the placeholder
# if it is a KuskoHarv* package, must link to my GitHub
# otherwise, use standardized CRAN link
get_url = function(pkg) {
  
  # determine if this package is one the the family
  is_kusko = stringr::str_detect(pkg, "KuskoHarv")
  
  # use my GitHub if so, CRAN if not
  if (is_kusko) {
    url = paste0("https://www.github.com/bstaton1/", pkg)
  } else {
    url = paste0("https://CRAN.R-project.org/package=", pkg)
  }
  
  # return the output
  return(url)
}

# get the URLs for each package and perform the replacement
tab[,"pkg"] = stringr::str_replace(tab[,"pkg"], "URL", sapply(used_pkgs, get_url))

# return the kable
kableExtra::kbl(tab, "markdown", col.names = c("Package", "Version", "Description"), align = "lrl")
```


</details>

Running the code below will display the packages not already installed on your machine:

```{r, eval = TRUE, echo = FALSE}
check_code = paste0("```R\npkgs <- c(", knitr::combine_words(used_pkgs, before = '"', and = "", sep = ', '), ")\npkgs[!pkgs %in% rownames(installed.packages())]\n```")
```

`r check_code`

## Reproducing Article Content

To reproduce all content presented in the manuscript, open [RStudio](https://posit.co/download/rstudio-desktop/) to the `KuskoHarvEst-ms-analysis.Rproj` location and execute:

``` r
source("make-figures.R")                   # exports PNG files for manuscript
source("make-tables.R")                    # exports CSV files for manuscript
source("make-in-text-summaries.R")         # examine output line-by-line, output saved
source("effort-simulation/simple-sim.R")   # exports a figure
source("effort-simulation/complex-sim.R")  # may take an hour or more; exports a figure
```

After executing this code, the there will be two new subdirectories: `figures` and `tables` storing the content used in building the manuscript.

## Session Info

<details>
<summary><b>Click to Expand/Hide Session Info</b></summary>

```{r message = FALSE, warning = FALSE}
junk = suppressPackageStartupMessages({
  sapply(used_pkgs, library, character.only = TRUE)
})
```

```{r}
sessioninfo::session_info()
```

</details>
